 {% extends 'dashboard/base.html' %}
{% load user_data %}
 {% block content %}
<h1 style="left: 5%;
top: -0.4%;
position: fixed;
font-size: 28px;">Milestones</h1>
<div class="history_extreme_outer"> 
<div class="history_outer">
 

    <div class="history_right_content" id="history_right_content">
          <div class="history_left_pane">
        <div class="timeline_title_outer"> 
            <div class="timeline_title">Timeline
               

            </div>
        </div>  

        <div class="left_months_outer_history"> 
            {% for month in months_set %}
            <div class="left_months_history">
             {{month}}
            </div>
     
           
            {% endfor %}
               </div>
    </div>





            <div class="right_content_wrapper">

         
            <div class="top_timeline">
                   {% for date in dates_set %}
                   <div class="weeks_history">
                      {{date}}
                   </div>
                       {% endfor %}
            </div>
            <div class="bottom_events" id="bottom_events">
                
                   
                 {% for month in months_set %}
                  <div class="month_row_history" id="months_row{{forloop.counter}}"> 
                    {% for empty_milestone in empty_count_dict|get_item:month %}
                    <div class="milestone_div_empty">
                    </div>
                    {% endfor %}
                    {% for milestone in milestones_dict|get_item:month %}
                    <div class="milestone_div {% if milestone.date.day == now.day %} 
                    glowing_milestone {% endif %}">{{milestone}}
                    </div>
                    {% endfor %}
                  </div>
                     
                       {% endfor %}
            </div>


    </div>
             </div>        
   {% if user.userprofile.role.name in allowed_roles %}
   
  
    <button onclick="setVisibleFlex(this, 'goal_modal')" class="history_right_btn">
      Set goals</button>
    
     {% endif %}
</div>
            <div class="goals_modal_history" id="goal_modal">
                  <div class="x_btn_goals" onclick="document.getElementById('goal_modal').style.display='none'">
                    x</div>
             
                <div class="add_goals">
                   <form method ="post" class="goals_form">
                     {% csrf_token %}
                 <div class="goal_form_name">
                    {{goal_form.name.label_tag}}
                     {{goal_form.name}}
                     </div>

                      <div>
                            {{goal_form.accomplished.label_tag}}
                            {{goal_form.accomplished}}
                           </div>

                        ---------------------
                     <div class="goal_form_type">
                        {{goal_form.type.label_tag}}
                        {{goal_form.type}}
                     </div>
                      <div class="goal_form_value">
                        {{goal_form.value.label_tag}}
                         {{goal_form.value}}
                         </div>
                           <div class="goal_form_value_type">
                            {{goal_form.value_type.label_tag}}
                           {{goal_form.value_type}}
                           </div>
                          
                          
                     <input type="submit" class="submit_form_goal">
                   </form>
                </div>
                 

            </div>



    <div class="bot_current_goals">
        <div class="current_goals_title">
            Goals
        </div>
        <div class="current_goals_content">
           {% for goal in goals %}
           {% if not user.userprofile.role.name in allowed_roles %}
           <div class="pending_goals_div {% if goal.failed %} pending_failed_div {% endif %}"
           id="pending{{goal.id}}" data-title="{{goal.type.description}}" data-value="{{goal.value}}"> 
               {{goal}}
          

           </div>
               {% else %}
              
                  <div class="pending_goals_div {% if goal.failed %} pending_failed_div {% endif %}"
                   id="pending{{goal.id}}" data-title="{{goal.type.description}}" data-value="{{goal.value}}" 
                  onclick="document.getElementById('del_goal_modal').style.display ='block';
                  document.getElementById('del_btn').value = '{{goal.id}}'"> 

           {{goal}}

           </div>
           {% endif %}
            {% endfor %}
        </div>

    </div>

</div>




<div id="del_goal_modal">
   <div class="del_goal_text">
   Delete goal ?
   </div>
   <form method="post" class="del_btn_goal">
   {% csrf_token %}

   <button name="del" id="del_btn" type="submit"> Delete</button>
  </form>

        <button class="x_btn_add_file"
         onclick="document.getElementById('del_goal_modal').style.display = 'none'">
          X
        </button>
         
</div>


<div id="info_bubble">
  <div id="value_bubble">

  </div>
  


</div>



<script>
function setdetailBubble() {
  const chart_icon = document.querySelectorAll('.pending_goals_div');  
  
  const text_value = document.getElementById('value_bubble'); 
  const info = document.getElementById('info_bubble');
 
  chart_icon.forEach(icon => {
    icon.addEventListener('mouseenter', () => {
      const rect = icon.getBoundingClientRect();
      const title = icon.dataset.title;
      const value = icon.dataset.value;
      
      
      text_value.innerText = value + " " + title
      info.style.display = 'flex';

      let top = rect.bottom;
      let left = rect.left + 20;

      const modalWidth = info.offsetWidth;
      const modalHeight = info.offsetHeight;
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      if (left + modalWidth > viewportWidth) {
        left = viewportWidth - modalWidth - 10;
      }
      if (top + modalHeight > viewportHeight) {
        top = rect.top - modalHeight - 10;
      }

      info.style.position = 'absolute';
      info.style.top = `${top}px`;
      info.style.left = `${left}px`;
    });

    icon.addEventListener('mouseleave', () => {
      info.style.display = 'none';
    });
  });
}

document.addEventListener('DOMContentLoaded', setdetailBubble);




    const input = document.getElementById('id_value')

      Inputmask("9999").mask(input);




const n_of_milestone = '{{milestones_count}}'
const months_count = '{{months_count}}'
const pxPerMS = 119; 
const pxPerMonth = 64.08
const offsetPx = (n_of_milestone -7) * pxPerMS;
const offsetMonth = (months_count - 6) * pxPerMonth;

const container = document.getElementById('history_right_content');
container.scrollLeft = offsetPx;
container.scrollTop = offsetMonth;

const months_row = document.querySelectorAll('[id^="months_row"]')
months_row.forEach(row=>{
  row.style.width=`${(pxPerMS * n_of_milestone)}px`
  
})
</script>
 {% endblock %}
